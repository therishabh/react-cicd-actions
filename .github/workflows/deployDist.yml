name : Deploy Dist
on: [push, workflow_dispatch]

env:
    NODE_VERSION: 20
    NODE_ENV: production

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Get Code
              uses: actions/checkout@v4

            #   run : |
            #      echo "Getting Code..."
            #      echo "${{toJson(github)}}"
            #      git clone "https://github.com/${{github.repository}}.git"
            #      echo "Code retrieved successfully.";

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Print Node.js version
              run: node --version

            - name: Print npm version
              run: npm --version

            - name : Cache node modules
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-npm-${{ hashFiles('**/package-lock.json') }}

            - name : Install dependencies
              run: npm ci --prefer-offline --no-audit --progress=false
            
            - name : Run Tests
              run: npm run test
            
    deploy:
        runs-on: ubuntu-latest
        needs: test
        steps:
            - name: Get Code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
        
            - name : Cache node modules
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-npm-${{ hashFiles('**/package-lock.json') }}

            - name : Install dependencies
              run: npm ci --prefer-offline --no-audit --progress=false
            
            - name : Build project
              run: npm run build
            
            - name : Deploy to server
              run: |
                echo "Deploying to server..."
                # Add your deployment commands here, e.g., scp, rsync, etc.

#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v2

#       - name: Set up Node.js
#         uses: actions/setup-node@v2
#         with:
#           node-version: '16'

#       - name: Install dependencies
#         run: npm install

#       - name: Build project
#         run: npm run build

#       - name: Deploy to server
#         run: |
#           echo "Deploying to server..."
#           # Add your deployment commands here, e.g., scp, rsync, etc.